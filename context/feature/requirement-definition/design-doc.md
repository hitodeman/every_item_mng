# 備品在庫管理システム 設計方針書

## 📋 概要

本ドキュメントは、複数支店を持つ介護事業者向け備品在庫管理システムの実装方針を示す。Webブラウザ利用を前提とし、将来的なiPhoneアプリ対応も考慮したクロスプラットフォーム設計とする。

## 🔍 要件の分析

- 支店ごとの在庫数管理、過不足の可視化
- ユーザー権限（管理者/支店管理者/支店一般ユーザー）による操作範囲制御
- 操作ログの記録・閲覧（CSVエクスポート含む）
- 在庫アイテムの単位・金額（整数・税込・日本円）管理
- 閾値アラート、履歴グラフ表示（棒グラフ）
- パスワード8文字以上、セキュリティ要件は今後提案

## 🛠 実装方針

### アーキテクチャ選択

- フロントエンド：React + TypeScript（Next.js等のSPA/SSRフレームワークを推奨）
- バックエンド：Node.js（Express等）
- データベース：Supabase（PostgreSQLベース、DB切り替え可能な汎用設計）
- クロスプラットフォーム対応：PWA（Progressive Web App）を基本とし、将来的なiOSアプリ化も見据える

### コンポーネント設計

- ログイン/認証コンポーネント（権限ごとにルーティング制御）
- ダッシュボード（支店別在庫・アラート表示）
- 在庫管理（追加・編集・論理削除・履歴）
- ユーザー管理（管理者/支店管理者のみ）
- 操作ログ管理（閲覧・CSVエクスポート）
- グラフ表示（履歴データの可視化）

### データフロー

- REST APIまたはGraphQLでフロント・バック間通信
- 権限ごとにAPIアクセス制御
- 操作ログ・在庫履歴はDBに記録、必要に応じてCSV出力
- 単位・金額・閾値等はバリデーションをフロント/バック双方で実施
- DBからのデータ取得は10件ずつのページネーション（グラフ表示以外）

## 🔄 実装方法の選択肢と決定

### 選択肢1: PWA（Webアプリ）+ Node.js + Supabase

- メリット：iPhone/Android/PCで同一UI、将来的なアプリ化も容易、DB切り替えも容易
- デメリット：一部ネイティブ機能制約あり

### 決定: PWAベースWebアプリ + Node.js + Supabase

- 理由：現段階でWeb利用が主目的、将来的なiPhoneアプリ化もPWAで対応可能なため
- 期待効果：開発・運用コストの最適化、ユーザー体験の統一、DB切り替えの柔軟性

## 📊 技術的制約と考慮事項

- 単位入力は半角数字4桁制限、全角→半角変換、数字以外は不可
- 金額は整数・日本円固定、税込
- 操作ログ・在庫アイテムは論理削除
- 多言語対応不要、日本語のみ
- パスワード8文字以上
- セキュリティ要件は今後提案
- iOS通知・オフライン対応は不要
- CSVエクスポートの大規模データ対応は後回し

## 🔐 権限管理の詳細設計（提案）

- APIレベル：JWT等による認証・認可。各APIエンドポイントでロール（管理者/支店管理者/一般）を判定し、アクセス制御。
- DBレベル：SupabaseのRow Level Security（RLS）を活用し、ユーザーの所属支店や権限に応じてデータアクセスを制限。
- 管理者：全データアクセス可
- 支店管理者：担当支店のデータのみアクセス可
- 一般ユーザー：担当支店の在庫データの追加・個数増減のみ可


## 🔒 認証・認可ガード・リダイレクト・フラッシュ防止の設計方針
- layout.tsxはサーバーコンポーネントのまま、クライアントガードはAuthGuardやadmin/user/layout.tsxで実装
- /login以外は未ログイン時に/loginへリダイレクト
- /admin, /user配下はrole判定し、認証判定中は何も描画しないことでフラッシュ防止

## ❓ 解決すべき技術的課題（現時点での対応方針）

- DBからのデータ取得は10件ずつのページネーション（グラフ表示以外）
- CSVエクスポートの大規模データ対応は今後検討
- 権限管理はAPI/DB両方で制御し、セキュリティを担保

