# 備品在庫管理システム 要件定義書

## 📋 概要

複数支店を持つ介護事業者向けに、各支店ごとの備品在庫を適切に管理し、過剰在庫や在庫不足を防止するための在庫管理システムを構築する。ユーザー権限ごとに操作範囲を制御し、iPhoneアプリまたはWebブラウザから利用可能とする。

## 🎯 要求

- 各支店ごとに備品の在庫数を把握・管理したい
- ユーザー権限（管理者/支店管理者/支店一般ユーザー）ごとに操作範囲を制御したい
- 支店一般ユーザーの操作ログを管理者・支店管理者が閲覧できるようにしたい
- iPhoneアプリまたはWebブラウザから利用したい
- 在庫アイテムごとに単位を含めて個数の増減・表示をしたい
- 在庫アイテムの金額も管理したい
- 過去3ヶ月分の在庫履歴をもとに当月必要数を表示したい（グラフ等）
- 在庫アイテムのストック数が閾値以下の場合、アラートを表示したい

## 📝 機能仕様

### 画面/コンポーネント構成
- ログイン画面
- ダッシュボード（支店ごとの在庫一覧、アラート表示）
- 在庫アイテム管理画面（追加・削除・編集・履歴表示）
- ユーザー管理画面（管理者/支店管理者のみ）
- 操作ログ閲覧画面（管理者/支店管理者のみ）
- グラフ・分析画面（過去履歴・必要数予測）

### 追加仕様
 - 操作ログのダウンロード・エクスポート機能（CSV形式）を実装
 - 操作ログは「ログイン成功時」「在庫数増減時」など主要操作で自動記録
 - 操作ログの閲覧・CSV出力は管理者のみ可能
 - Supabase RLSで「管理者は全件参照可、一般ユーザーは自分のログのみ参照可」等の制御を実装
- 多言語対応は不要（日本語のみ）
 - 操作ログの保存・閲覧・CSVエクスポート機能を実装すること
 - 操作ログテーブル（operation_logs）にはRLS（Row Level Security）を適用し、管理者・ユーザーの参照範囲を厳格に制御すること
### 振る舞い
- 管理者は全支店の在庫状況・操作ログ・ユーザー管理が可能
- 支店管理者は担当支店の在庫状況・操作ログ・ユーザー管理が可能
- 支店一般ユーザーは担当支店の在庫アイテム追加・個数増減が可能
- 在庫アイテムごとに単位（例：12個入り、8個入り等）を設定し、個数増減・表示
- 在庫アイテムの金額入力・表示
- 過去3ヶ月分の在庫履歴をもとに当月必要数をグラフ等で表示
- 在庫ストック数が閾値以下の場合、アラート表示（アイテムごとに閾値設定可能）

### 制約条件
- iPhoneアプリまたはWebブラウザで利用可能であること
- 権限ごとにアクセス制御を厳格に行うこと
- 操作ログの保存・閲覧機能を実装すること

## 📊 データ要件
- 支店情報（支店名、ID等）
- ユーザー情報（氏名、ID、権限、所属支店等）
- 在庫アイテム情報（名称、単位、金額、現在数、閾値、履歴等）
- 操作ログ（ユーザー、操作内容、日時等）
- 在庫履歴（過去3ヶ月分の入出庫履歴）

## 🔄 インタラクション
- ユーザー認証・権限管理
- 全ページ共通で認証・認可ガードを実装し、未ログイン時は/loginへリダイレクト
- /admin配下はadminのみ、/user配下はuserのみアクセス可。認証判定中は何も描画しないことでフラッシュ防止
- 支店ごとの在庫データ集計
- 操作ログの記録・閲覧
- グラフ・分析用データの集計

## ✅ 解決済みの仕様
- 現段階ではWebブラウザでの利用を前提とし、将来的なiPhoneアプリ対応も考慮してクロスプラットフォーム技術を採用する
- 在庫アイテムの単位は自由入力とする
- 金額管理は税込で行う
- 既存データの取り込みは不要
- 操作ログの保存期間は1年とし、閲覧範囲はユーザー操作（アイテムの追加・個数増減・操作年月日・操作対象アイテム名）とする
